---
title: "Demo"
author: "Mayleen"
date: "2025-05-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```
# Load Libraries
```{r, message=FALSE}
library(readr)
library(tidyverse, warn.conflicts = FALSE)
library(data.table)
library(dplyr, warn.conflicts = FALSE)
library(ggthemes)
library(ggplot2)
```

## Load functions for cleaning
```{r, eval=FALSE}
source("SCRIPTS/clean_CORE.R")
source("SCRIPTS/clean_helper.R")
source("SCRIPTS/download_data.R")
source("SCRIPTS/clean_BMF.R")
```

Make sure you are in the home directory "rgai_summer2025_nccs"

# Download data
If you already downloaded the data you want to work with, you can skip this part!

```{r, eval=FALSE}
tscope_values <- c("501c3") # Download files from Tax Exempt Types in this list; possible values: "501c3", "501ce" 
fscope_values <- c("-pz") # Download files from IRS 990 Form Scope in this list; possible values: "-pz", "-pc", "-pf"
year_values <- seq(from = 1989, to = 2022, by = 1) # Download files from years in this list

download_CORE(tscope_values, fscope_values, year_values) # this function from download_data.R will download the data for you onto your local computer
download_dicts() # download the data dictionaries
download_bmf() # download Business Master File (BMF) for you onto your local computer
```

# Clean Business Master File (BMF)
If you already cleaned the BMF file, you can skip this part.
```{r, eval=FALSE}
vars_to_keep <- c("EIN2", "NTEEV2", "F990_TOTAL_ASSETS_RECENT", "CENSUS_STATE_ABBR", "CENSUS_COUNTY_NAME", "ORG_YEAR_FIRST", "ORG_YEAR_LAST", "LATITUDE", "LONGITUDE", "CENSUS_CBSA_FIPS") # variables in BMF we wil keep (the rest will be dropped)
thresh <- 0.5*length(vars_to_keep) # Any rows with more NA values than this threshold will be dropped

dir.create("CLEAN")
clean_BMF(vars_to_keep, thresh, saveFlag=TRUE) # this function from clean_BMF.R cleans the BMF file for you and saves to your computer in CLEAN folder if you set saveFlag to TRUE, otherwise creates list e.g. cleanBMF.list <- clean_BMF(vars_to_keep, thresh, saveFlag = FALSE)
```

# Clean CORE Data and merge with BMF
If you already cleaned the CORE files and created the resulting merged dataset, you can skip this part.
```{r, eval=FALSE}
outcome_vars <- c("F9_10_ASSET_TOT_BOY", "F9_10_ASSET_TOT_EOY", "F9_01_REV_TOT_CY", "F9_08_REV_TOT_TOT")
predictor_vars <- c("F9_00_EXEMPT_STAT_501C3_X", "TAX_YEAR")
all_relevant_vars <- c(outcome_vars, predictor_vars, "EIN2", "F9_00_TAX_PERIOD_END_DATE")

prop_NA <- 0.5 # If a column has more than this fraction of missing values, warning message prints
file_name_tag <- "-501C3-CHARITIES-PZ-HRMN.csv" 
file_dir <- "CORE/pz/CORE-"
save_dir <- "CLEAN/pz/"

dir.create(save_dir)
clean_CORE(all_relevant_vars, year_values, file_name_tag, file_dir, save_dir, prop_NA) # this function from clean_CORE.R cleans the CORE files, merges with cleaned BMF file, and saves resulting data frame
```

# Load the (cleaned/merged) data frame into the environment
```{r}
load_dir <- "CLEAN/pz/"
year_values <- seq(from = 1989, to = 2022, by = 1)

filename <- paste(load_dir, "cleanCORE_", year_values[1], "-", year_values[length(year_values)], ".csv", sep="")
df <- as.data.table(read_csv(filename, show_col_types = FALSE)) |> filter(TAX_YEAR!=2022)

head(df |> select(EIN2, TOT_REV, TAX_YEAR, NTEE, SIZE.CTS, SIZE.CAT))
```

# Visualizations: Overall

## Histograms
```{r, eval=FALSE}
ggplot(data = df, mapping = aes(x = log(TOT_REV + 1))) +
  geom_histogram() +
      labs(x = "LOG(TOTAL REVENUE) in USD", title = "Histogram of log(total revenue)")
```

## Line Plots
Total revenue across all nonprofits over time
```{r, fig.align="center", fig.width = 14, eval=FALSE}
df |>
  group_by(TAX_YEAR) |>
  summarise(sum_TOT_REV = sum(TOT_REV, na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = sum_TOT_REV)) +
  geom_point() +
  geom_line() +
  labs(x = "Year", y = "Dollars", title = "Total Revenues, 1989-2021")
```

Total revenue across all nonprofits, grouped by size (total assets), over time
```{r, fig.align="center", fig.width = 14, eval=FALSE}
size_labs <- c("Under $100,000", "$100,000 - $499,999", "$500,000 - $999,999", "$1 Million - $4.99 Million", "$5 Million - $9.99 Million", "Above $10 Million")
size_palette <- c("#1796D2", "#D2D2D2", "#000000", "#FDC010", "#ED028B", "#55B748")

df |>
  mutate(SIZE.CAT = factor(SIZE.CAT)) |>
  group_by(SIZE.CAT, TAX_YEAR) |>
  summarise(sum_TOT_REV = sum(TOT_REV, na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = sum_TOT_REV, color = SIZE.CAT)) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = size_palette, labels = size_labs, na.translate = FALSE) +
  labs(x = "Year", y = "Dollars", title = "Total Revenues, 1989-2021")
```

Total revenue across all nonprofts, grouped by NTEE code, over time
```{r, fig.align="center", fig.width = 14, eval=FALSE}
ntee_labs <- c("Arts, Culture, and Humanities", "Education (minus Universities)", "Environment and Animals", "Health (minus Hospitals)", "Human Services", "Hospitals", "International, Foreign Affairs", "Mutual/Membership Benefit", "Public, Societal Benefit", "Religion Related", "Universities", "Other")

ntee_palette <- c("#1796D2", "#8DBCD2", "#989898", "#131313", "#F99C28", "#8A6908", "#EF2174", "#A7546C", "#5A7254", "#8A4846", "#DC2B28", "#55AE49")

df |>
  mutate(NTEE = factor(NTEE)) |>
  group_by(NTEE, TAX_YEAR) |>
  summarise(sum_TOT_REV = sum(TOT_REV, na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = sum_TOT_REV, color = NTEE)) +
  geom_point() +
  geom_line() +
  scale_color_manual(values = ntee_palette, labels = ntee_labs, na.translate = FALSE) +
  labs(x = "Year", y = "Dollars", title = "Total Revenues, 1989-2021")
```

Average and median log total revenue
```{r, fig.align="center", fig.width = 14, eval=FALSE}
library(cowplot)

mean_plot <- df |>
  group_by(TAX_YEAR) |>
  summarise(mean_log_rev = mean(log(TOT_REV + 1), na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = mean_log_rev)) +
  geom_line() +
  labs(x = "Year", y = "LOG(Dollars)", title = "Mean Log Revenues, 1989-2021")

med_plot <- df |>
  group_by(TAX_YEAR) |>
  summarise(med_log_rev = median(log(TOT_REV + 1), na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = med_log_rev)) +
  geom_line() +
  labs(x = "Year", y = "LOG(Dollars)", title = "Median Log Revenues, 1989-2021")

plot_grid(mean_plot, med_plot, labels = "AUTO")
```

Average and median log of total revenue, grouped by size
```{r, fig.align="center", fig.width = 14, eval=FALSE}
size_labs <- c("Under $100,000", "$100,000 - $499,999", "$500,000 - $999,999", "$1 Million - $4.99 Million", "$5 Million - $9.99 Million", "Above $10 Million")
size_palette <- c("#1796D2", "#D2D2D2", "#000000", "#FDC010", "#ED028B", "#55B748")

mean_plot <- df |>
  mutate(SIZE.CAT = factor(SIZE.CAT)) |>
  group_by(TAX_YEAR, SIZE.CAT) |>
  summarise(mean_log_rev = mean(log(TOT_REV + 1), na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = mean_log_rev, color=SIZE.CAT)) +
  geom_line() +
  scale_color_manual(values = size_palette, labels = size_labs, na.translate = FALSE) +
  labs(x = "Year", y = "LOG(Dollars)", title = "Mean Log Revenues, 1989-2021")

med_plot <- df |>
  mutate(SIZE.CAT = factor(SIZE.CAT)) |>
  group_by(TAX_YEAR, SIZE.CAT) |>
  summarise(med_log_rev = median(log(TOT_REV + 1), na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = med_log_rev, color=SIZE.CAT)) +
  geom_line() +
  scale_color_manual(values = size_palette, labels = size_labs, na.translate = FALSE) +
  labs(x = "Year", y = "LOG(Dollars)", title = "Median Log Revenues, 1989-2021")

prow <- plot_grid(mean_plot + theme(legend.position="none"), med_plot + theme(legend.position="none"), labels = "AUTO", hjust = -1, nrow = 1)
leg <- get_legend(mean_plot + theme(legend.position = "bottom"))
plot_grid(prow, leg, ncol = 1, rel_heights = c(1, .1))
```

Average and median log of total revenue, grouped by NTEE
```{r, fig.align="center", fig.width = 14, eval=FALSE}
ntee_labs <- c("Arts, Culture, and Humanities", "Education (minus Universities)", "Environment and Animals", "Health (minus Hospitals)", "Human Services", "Hospitals", "International, Foreign Affairs", "Mutual/Membership Benefit", "Public, Societal Benefit", "Religion Related", "Universities", "Other")
ntee_palette <- c("#1796D2", "#8DBCD2", "#989898", "#131313", "#F99C28", "#8A6908", "#EF2174", "#A7546C", "#5A7254", "#8A4846", "#DC2B28", "#55AE49")

mean_plot <- df |>
  mutate(NTEE = factor(NTEE)) |>
  group_by(TAX_YEAR, NTEE) |>
  summarise(mean_log_rev = mean(log(TOT_REV + 1), na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = mean_log_rev, color=NTEE)) +
  geom_line() +
  scale_color_manual(values = ntee_palette, labels = ntee_labs, na.translate = FALSE) +
  labs(x = "Year", y = "LOG(Dollars)", title = "Mean Log Revenues, 1989-2021")

med_plot <- df |>
  mutate(NTEE = factor(NTEE)) |>
  group_by(TAX_YEAR, NTEE) |>
  summarise(med_log_rev = median(log(TOT_REV + 1), na.rm = TRUE)) |>
  ggplot(aes(x = TAX_YEAR, y = med_log_rev, color=NTEE)) +
  geom_line() +
  scale_color_manual(values = ntee_palette, labels = ntee_labs, na.translate = FALSE) +
  labs(x = "Year", y = "LOG(Dollars)", title = "Median Log Revenues, 1989-2021")

prow <- plot_grid(mean_plot + theme(legend.position="none"), med_plot + theme(legend.position="none"), labels = "AUTO", hjust = -1, nrow = 1)
leg <- get_legend(mean_plot + theme(legend.position = "bottom"))
plot_grid(prow, leg, ncol = 1, rel_heights = c(1, .3))
```

# Visualizations: per organization
Total revenue for each individual organization over time
```{r, eval=FALSE}
df |>
  ggplot(aes(x = TAX_YEAR, y = TOT_REV, color = EIN2)) +
  geom_line() +
  scale_color_discrete(na.translate = FALSE) +
  labs(x = "Year", y = "Dollars", title = "Revenues, 1989-2021") +
  theme(legend.position = "none")
```

Total revenue for individual organizations, but each plot is a different NTEE code group
```{r, eval=FALSE}
ntee_codes <- c("ART", "EDU", "ENV", "HEL", "HMS", "HOS", "IFA", "MMB", "PSB", "REL", "UNI", "UNU")

for (i in seq(1,length(ntee_codes),1)){
  my_plot <- df |>
  filter(NTEE == ntee_codes[i]) |>
  ggplot(aes(x = TAX_YEAR, y = TOT_REV, color = EIN2)) +
  geom_line() +
  scale_color_discrete(na.translate = FALSE) +
  labs(x = "Year", y = "Dollars", title = paste("Revenues (", ntee_labs[i], "), 1989-2021", sep="")) +
  theme(legend.position = "none")
  print(my_plot)
}
```

Total revenue for individual organizations, but each plot is a different size (total assets)
```{r, eval=FALSE}
for (i in seq(1,length(size_labs),1)){
  my_plot <- df |>
  filter(SIZE.CAT == i) |>
  ggplot(aes(x = TAX_YEAR, y = TOT_REV, color = EIN2)) +
  geom_line() +
  scale_color_discrete(na.translate = FALSE) +
  labs(x = "Year", y = "Dollars", title = paste("Revenues, 1989-2021, SIZE: ", size_labs[i], sep="")) +
  theme(legend.position = "none")
  print(my_plot)
}
```

# Nearest Neighbor + Gaussian Process Prediction Approach
```{r}
source("app_helper.R")

df <- readRDS("PREPROCESSING/processed_mega_df_app.rds")

# User-supplied information
user.EIN <- "EIN-00-0000000" # user-supposed Employee Identification Number
user_years <- c(2022, 2023, 2024) # user-supplied years, must be minimum length 2, maximum length 5
user.history <- c(62369, 100199, 185830) # user-supplied revenue history, 1 per year
category <- "ART" # NTEE Category selected by the user from a dropdown menu
n.data <- length(user.history) # number of data points in user-supplied history
n_pred <- 2 # number of years the user wants to predict into (selected from a drop down list with options 1, 2, 3)
```

```{r}
res <- nn.search(category, user.EIN, user_years, user.history, n_pred) # nearest neighbor search; returns top 5 neighbors
res.pars <- gp.param.opt(res, user.EIN, user_years, user.history, n_pred) # finds "optimal" nu and nugget term for GP trained on res data
user_data_df <- gp.predict(res, res.pars, user.EIN, user_years, user.history, n_pred) # returns the GP predictions for the user
```

```{r}
# This is the interactive plot in the app
first_year <- min(user_years)
last_year <- max(user_years)
user_data_df$TAX_YEAR <- seq(first_year, last_year + n_pred)

deg.freedom <- nrow(res |> filter(!IMPUTED)) - 1
user_data_df <- user_data_df |>
      mutate(CI.LOWER = case_when(
            IMPUTE_STATUS == "Reported" ~ TOT_REV,
            IMPUTE_STATUS == "Predicted" ~ TOT_REV - qt(0.95, df = deg.freedom) * SE)) |>
      mutate(CI.UPPER = case_when(
            IMPUTE_STATUS == "Reported" ~ TOT_REV,
            IMPUTE_STATUS == "Predicted" ~ TOT_REV + qt(0.95, df = deg.freedom) * SE)) 

df_reported <- user_data_df %>% filter(IMPUTE_STATUS == "Reported")
df_predicted <- user_data_df %>% filter(IMPUTE_STATUS == "Predicted")
df_transition <- user_data_df %>% filter((TAX_YEAR == last_year) | (TAX_YEAR == last_year+1))

df_peers <- res |> 
      mutate(label = paste("Organization ", NEIGHBOR_ID, ": ", EIN2, sep = "")) |> 
      group_by(NEIGHBOR_ID) |> 
      mutate(TAX_YEAR = seq(first_year, last_year + n_pred)) |> 
      ungroup() |> 
      mutate(label = factor(label, levels = unique(label[order(NEIGHBOR_ID)])))


p <- plot_ly() %>%
      # Lines for neighbor organizations
      add_trace(data = df_peers,
                x = ~TAX_YEAR, y = ~TOT_REV, color = ~label, symbol = ~label, 
                colors = c("#648FFF", "#785EF0", "#DC267F","#FE6100", "#FFB000"),
                opacity = 0.6, type = 'scatter', mode = 'lines+markers') %>%
      
      # Line for reported
      add_trace(data = df_reported,
                x = ~TAX_YEAR, y = ~TOT_REV,
                type = 'scatter', mode = 'lines+markers',
                line = list(dash = "solid", color = "black", width = 3),
                marker = list(symbol = "circle", color = "black", size = 8.5),
                name = "Reported")
      
      # Conditional CI addition
      if (nrow(df_predicted) > 1) {
            p <- p %>%
                  # Lower bound
                  add_trace(data = df_predicted,
                            x = ~TAX_YEAR, y = ~CI.LOWER,
                            type = 'scatter', mode = 'lines',
                            line = list(width = 1, color="grey"),
                            showlegend = FALSE,
                            name = "CI Lower",
                            hoverinfo = "none") %>%
                  # Upper bound with fill
                  add_trace(data = df_predicted,
                            x = ~TAX_YEAR, y = ~CI.UPPER,
                            type = 'scatter', mode = 'lines',
                            fill = 'tonexty',
                            fillcolor = 'rgba(128, 128, 128, 0.2)',
                            line = list(width = 1, color="grey"),
                            showlegend = TRUE,
                            name = "95% Confidence Interval",
                            hoverinfo = "none")
      } else {
            # Error bar version
            p <- p %>%
                  add_trace(data = df_predicted,
                            x = ~TAX_YEAR, y = ~TOT_REV,
                            type = 'scatter', mode = 'markers',
                            marker = list(symbol = "circle-open", color = "black", size = 8.5),
                            error_y = list(
                                  type = "data",
                                  symmetric = FALSE,
                                  array = df_predicted$CI.UPPER - df_predicted$TOT_REV,
                                  arrayminus = df_predicted$TOT_REV - df_predicted$CI.LOWER,
                                  color = "gray",
                                  showlegend = TRUE
                            ),
                            name = "95% Confidence Interval")
      }

# Line for predicted
p <- p |> add_trace(data = df_predicted,
                    x = ~TAX_YEAR, y = ~TOT_REV,
                    type = 'scatter', mode = 'lines+markers',
                    line = list(dash = "dash", color = "black", width = 2.5),
                    marker = list(symbol = "circle-open", color = "black", size = 8.5),
                    name = "Predicted") %>%
      
      # Line for transition
      add_trace(data = df_transition,
                x = ~TAX_YEAR, y = ~TOT_REV,
                type = 'scatter', mode = 'lines',
                line = list(dash = "dash", color = "black", width = 2.5),
                name = "", showlegend = FALSE, hoverinfo = "none") %>%
      
      
      layout(
            title = paste("Comparing Your Organization to Similar ", category, " Organizations", sep=""),
            xaxis = list(
                  title = "Year",
                  tickformat = ".0f",    # force no decimals
                  tickmode = "linear",   # evenly spaced ticks
                  dtick = 1,             # step size = 1 year
                  separatethousands = FALSE  # prevent commas
            ),
            yaxis = list(title = "Revenue"),
            legend = list(title = list(text = "Legend"), traceorder = "normal")
      )
p
```

